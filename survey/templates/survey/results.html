{% extends "survey/base.html" %}
{% load anime_util %}
{% load util %}

{% block head %}
<script>
    function genericNumberFormatter(value, validFormatter) {
        switch (value) {
            case 'nan':
                return 'NaN';
            case 'inf':
                return '\u221e';
            default:
                return validFormatter(value)
        }
    }

    function percentageFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(1) + '%');
    }

    function genderRatioFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(2));
    }

    function scoreFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(2) + '/5');
    }
</script>
{% endblock %}

{% block content %}

<h1 class="mb-3">{{ survey }} Results!</h1>

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}


{% for table in table_list %}
<h2 class="mb-3">{{ table.title }}</h2>

<div class="row mb-3 justify-content-center">
    <div class="col-md-4 col-8 text-center font-weight-bolder">
        {% with anime_list=table.data.keys|listify %}
        <div class="row justify-content-center mb-4">
            <div class="col-8">
                {% get_anime_image anime_list.0 css_class='img-fluid' variant='l' %}
            </div>
            <div class="col-12">
                {% get_official_names anime_list.0 'div class="mb-1"' %}
            </div>
        </div>
        <div class="row" style="font-size:75%;">
            <div class="col-6">
                <div class="row justify-content-center">
                    <div class="col-10">
                        {% get_anime_image anime_list.1 css_class='img-fluid' variant='m' %}
                    </div>
                    <div class="col-12">
                        {% get_official_names anime_list.1 'div class="mb-1"' %}
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="row justify-content-center">
                    <div class="col-10">
                        {% get_anime_image anime_list.2 css_class='img-fluid' variant='m' %}
                    </div>
                    <div class="col-12">
                        {% get_official_names anime_list.2 'div class="mb-1"' %}
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
    </div>
    <div class="col-md col-10" id="results-table-{{ forloop.counter0 }}">
        <b-table-lite striped hover small bordered sticky-header="600px" :items="items" :fields="fields"></b-table>
    </div>
</div>
{% endfor %}


<div class="row justify-content-between mt-3">
    <div class="col-auto">
        <a href="{% url 'survey:index' %}" class="btn btn-secondary">Back to index.</a>
    </div>
    <div class="col-auto">
    </div>
</div>


<script>
    {% for table in table_list %}
    var app = new Vue({
        el: '#results-table-{{ forloop.counter0 }}',
        data: {
            fields: [{% for column in table.columns %}{
                    {% for key, value in column.as_keyvalue %}{% if key == 'formatter' %}{{ key }}: {{ value }}, {% else %}{{ key }}: '{{ value }}', {% endif %}{% endfor %}
                }, {% endfor %}
            ],
            items: [{% for row in table.data.values %}{
                    {% for key, value in row.items %}{{ key }}: '{{ value|safe|escapejs }}', {% endfor %}
                }, {% endfor %}
            ],
        }
    })
    {% endfor %}
</script>
{% endblock content %}