{% extends "survey/base.html" %}
{% load anime_util %}
{% load util %}

{% block head %}
<script>
    function genericNumberFormatter(value, validFormatter) {
        switch (value) {
            case 'nan':
                return 'NaN';
            case 'inf':
                return '\u221e';
            default:
                return validFormatter(value)
        }
    }

    function percentageFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(1) + '%');
    }

    function genderRatioFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(2));
    }

    function scoreFormatter(value) {
        return genericNumberFormatter(value, v => parseFloat(v).toFixed(2));
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<style>
    /*th {
        display: none;
    }*/
    .table-col-index {
        width: 5%!important;
    }
    .table-col-image {
        width: 15%!important;
    }
    .table-col-image-small {
        width: 10%!important;
    }
    .table-col-name {
        width: auto!important;
        position: relative!important;
    }
    .table-col-other {
        width: 10%!important
    }
    .table-row-progress-bar {
        position: absolute;
        top: 0%;
        height: 100%;
        z-index: -10;
        /*border-radius:.25rem;*/
        background-color: rgb(199, 230, 250);
    }
    td {
        vertical-align: middle!important;
    }
</style>
{% endblock %}

{% block content %}

<h1 class="mb-3">{{ survey }} Results!</h1>

<div class="row">
    <div class="col-md-8">
        <div class="row"><div class="col">
            Thanks everyone for filling in this survey! There were {{ response_count }} responses,
            and the average age of everyone who answered was {{ average_age|floatformat:2 }}.
        </div></div>
        <div class="row mt-2"><div class="col">
            <canvas id="age-distribution-chart"></canvas>
        </div></div>
    </div>
    <div class="col-md-4">
        <canvas id="gender-distribution-chart"></canvas>
    </div>
</div>


{% for segment in segment_list %}
{% if segment.table %}
{% with table=segment.table %}
<h2 class="mb-3">{{ segment.title }}</h2>

<div class="row mb-3 justify-content-center">
    <div class="col-md-4 col-8 text-center">
        {% with anime_list=table.data.keys|listify %}
        {% if anime_list %}
        <div class="row justify-content-center mb-4">
            <div class="col-8 mb-2">
                {% get_anime_image anime_list.0 css_class='img-fluid' variant='l' %}
            </div>
            <div class="col-12">
                {% get_official_names anime_list.0 'div class="mb-1"' %}
            </div>
        </div>
        {% if anime_list|length >= 2 %}
        <div class="row" style="font-size:75%;">
            <div class="col-6">
                <div class="row justify-content-center">
                    <div class="col-10 mb-1">
                        {% get_anime_image anime_list.1 css_class='img-fluid' variant='m' %}
                    </div>
                    <div class="col-12">
                        {% get_official_names anime_list.1 'div class="mb-1"' %}
                    </div>
                </div>
            </div>
            {% if anime_list|length >= 3 %}
            <div class="col-6">
                <div class="row justify-content-center">
                    <div class="col-10 mb-1">
                        {% get_anime_image anime_list.2 css_class='img-fluid' variant='m' %}
                    </div>
                    <div class="col-12">
                        {% get_official_names anime_list.2 'div class="mb-1"' %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
        {% endwith %}
    </div>
    <div class="col-md col-10" id="results-table-{{ forloop.counter0 }}">
        <b-table-lite hover small borderless :items="items" :fields="fields">
            <template #cell(rank)="data">
                #{$ data.value $}
            </template>
            <template #cell(image)="data">
                <img :src="data.value" class="img-fluid"></img>
            </template>
            <template #cell(name)="data">
                <div class="ml-2 mr-2">
                    <div v-for="name in data.value">
                        {$ name $}
                    </div>
                </div>
                <div class="progress-bar table-row-progress-bar" :style="data.item.pbwidth"></div>
            </template>
        </b-table>
    </div>
</div>
{% endwith %}

{% else %}

<h3 class="mb-3">{{ segment.title }}</h3>

<div class="row mb-3 justify-content-center" style="font-size:75%;">
    <div class="col-md col-4" id="results-table-{{ forloop.counter0 }}-0">
        <b-table-lite hover small borderless :items="items" :fields="fields">
            <template #cell(rank)="data">
                #{$ data.value $}
            </template>
            <template #cell(image)="data">
                <img :src="data.value" class="img-fluid"></img>
            </template>
            <template #cell(name)="data">
                <div class="ml-2 mr-2">
                    <div v-for="name in data.value">
                        {$ name $}
                    </div>
                </div>
                <div class="progress-bar table-row-progress-bar" :style="data.item.pbwidth"></div>
            </template>
        </b-table>
    </div>
    <div class="col-md col-4" id="results-table-{{ forloop.counter0 }}-1">
        <b-table-lite hover small borderless :items="items" :fields="fields">
            <template #cell(rank)="data">
                #{$ data.value $}
            </template>
            <template #cell(image)="data">
                <img :src="data.value" class="img-fluid"></img>
            </template>
            <template #cell(name)="data">
                <div class="ml-2 mr-2">
                    <div v-for="name in data.value">
                        {$ name $}
                    </div>
                </div>
                <div class="progress-bar table-row-progress-bar" :style="data.item.pbwidth"></div>
            </template>
        </b-table>
    </div>
</div>
{% endif %}
{% endfor %}


<div class="row justify-content-between mt-3">
    <div class="col-auto">
        <a href="{% url 'survey:index' %}" class="btn btn-secondary">Back to index.</a>
    </div>
    <div class="col-auto">
    </div>
</div>


<script>
    {% for segment in segment_list %}
    {% if segment.table %}
    {% with table=segment.table %}
    new Vue({
        el: '#results-table-{{ forloop.counter0 }}',
        delimiters: ['{$', '$}'],
        data: {
            fields: [{% for column in table.columns %}{
                    {% for key, value in column.as_keyvalue %}{% if key == 'formatter' %}{{ key }}: {{ value }}, {% else %}{{ key }}: '{{ value }}', {% endif %}{% endfor %}
                }, {% endfor %}
            ],
            items: [{% for anime, row in table.data.items %}{
                    image: '{% get_anime_image_url anime variant="m" %}',
                    {% for key, value in row.items %}{{ key }}: {% if key == 'name' %}{{ value|safe }}{% elif key == 'pbwidth' %}'width:{{ value|floatformat:1 }}%;'{% else %}'{{ value|safe|escapejs }}'{% endif %}, {% endfor %}
                }, {% endfor %}
            ],
        }
    })
    {% endwith %}
    {% else %}
    {% with table_list=segment.table_list segment_idx=forloop.counter0 %}
    {% for table in table_list %}
    new Vue({
        el: '#results-table-{{ segment_idx }}-{{ forloop.counter0 }}',
        delimiters: ['{$', '$}'],
        data: {
            fields: [{% for column in table.columns %}{
                    {% for key, value in column.as_keyvalue %}{% if key == 'formatter' %}{{ key }}: {{ value }}, {% else %}{{ key }}: '{{ value }}', {% endif %}{% endfor %}
                }, {% endfor %}
            ],
            items: [{% for anime, row in table.data.items %}{
                    image: '{% get_anime_image_url anime variant="s" %}',
                    {% for key, value in row.items %}{{ key }}: {% if key == 'name' %}{{ value|safe }}{% elif key == 'pbwidth' %}'width:{{ value|floatformat:1 }}%;'{% else %}'{{ value|safe|escapejs }}'{% endif %}, {% endfor %}
                }, {% endfor %}
            ],
        }
    })
    {% endfor %}
    {% endwith %}
    {% endif %}
    {% endfor %}


    var distributionChartColor = 'rgb(54, 162, 235)';
    var distributionChartDatalabelColor = 'rgb(96, 96, 96)';

    var gdcCtx = document.getElementById('gender-distribution-chart').getContext('2d');
    var gdcChart = new Chart(gdcCtx, {
        type: 'bar',
        data: {
            labels: [{% for gender in gender_distribution.keys %}'{{ gender.name.lower|capfirst }}', {% endfor %}],
            datasets: [{
                label: 'Percentage of responders',
                backgroundColor: distributionChartColor,
                borderColor: distributionChartColor,
                data: [{% for value in gender_distribution.values %}{{ value|floatformat:1 }}, {% endfor %}],
            }],
        },
        options: {
            title: {
                display: true,
                text: 'Gender Distribution',
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = data.datasets[tooltipItem.datasetIndex].label || '';

                        if (label) {
                            label += ': ' + tooltipItem.yLabel + '%';
                        }
                        return label;
                    },
                },
            },
            legend: {
                display: false,
            },
            plugins: {
                datalabels: {
                    align: 'top',
                    anchor: 'end',
                    color: distributionChartDatalabelColor,
                    offset: -2,
                    formatter: function(value) {
                        return value + '%';
                    },
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        min: 0,
                        max: 100,
                    },
                }]
            },
        },
    });

    var adcCtx = document.getElementById('age-distribution-chart').getContext('2d');
    var adcChart = new Chart(adcCtx, {
        type: 'bar',
        data: {
            labels: [{% for age in age_distribution.keys %}{{ age }}, {% endfor %}],
            datasets: [{
                label: 'Percentage of responders',
                backgroundColor: distributionChartColor,
                borderColor: distributionChartColor,
                data: [{% for value in age_distribution.values %}{{ value|floatformat:2 }}, {% endfor %}],
            }],
        },
        options: {
            title: {
                display: true,
                text: 'Age Distribution',
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = data.datasets[tooltipItem.datasetIndex].label || '';

                        if (label) {
                            label += ': ' + tooltipItem.yLabel + '%';
                        }
                        return label;
                    },
                },
            },
            legend: {
                display: false,
            },
            plugins: {
                datalabels: {
                    align: 'top',
                    anchor: 'end',
                    color: distributionChartDatalabelColor,
                    offset: -2,
                    formatter: function(value, context) {
                        if (context.dataIndex % 2 == 0 && value > 0.1) {
                            return value + '%';
                        }
                        else {
                            return '';
                        }
                    },
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        },
                        min: 0,
                        max: Math.round({{ age_distribution_max }} * 1.1 + 0.5),
                    },
                }]
            },
        },
    });
</script>
{% endblock content %}